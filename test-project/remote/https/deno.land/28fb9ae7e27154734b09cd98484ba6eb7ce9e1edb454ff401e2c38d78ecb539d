// Copyright 2018-2023 the Deno authors. All rights reserved. MIT license.
// This module is browser compatible.

import { assert } from "../assert/assert.ts";

/**
 * A transform stream that only transforms from the zero-indexed `start` and `end` bytes (both inclusive).
 *
 * @example
 * ```ts
 * import { ByteSliceStream } from "https://deno.land/std@$STD_VERSION/streams/byte_slice_stream.ts";
 * const response = await fetch("https://example.com");
 * const rangedStream = response.body!
 *   .pipeThrough(new ByteSliceStream(3, 8));
 * ```
 */
export class ByteSliceStream extends TransformStream<Uint8Array, Uint8Array> {
  #offsetStart = 0;
  #offsetEnd = 0;

  constructor(start = 0, end = Infinity) {
    super({
      start: () => {
        assert(start >= 0, "`start` must be greater than 0");
        end += 1;
      },
      transform: (chunk, controller) => {
        this.#offsetStart = this.#offsetEnd;
        this.#offsetEnd += chunk.byteLength;
        if (this.#offsetEnd > start) {
          if (this.#offsetStart < start) {
            chunk = chunk.slice(start - this.#offsetStart);
          }
          if (this.#offsetEnd >= end) {
            chunk = chunk.slice(0, chunk.byteLength - this.#offsetEnd + end);
            controller.enqueue(chunk);
            controller.terminate();
          } else {
            controller.enqueue(chunk);
          }
        }
      },
    });
  }
}

// denoCacheMetadata={"headers":{"content-type":"application/typescript; charset=utf-8","content-length":"1415","cross-origin-embedder-policy":"same-origin","x-content-type-options":"nosniff","access-control-allow-origin":"*","age":"10040845","cross-origin-opener-policy":"same-origin","x-frame-options":"DENY","date":"Fri, 15 Nov 2024 05:48:46 GMT","etag":"\"53eb6e13cf63035dde9d9e2696509c84\"","cross-origin-resource-policy":"same-origin","last-modified":"Thu, 12 Oct 2023 22:56:04 GMT","referrer-policy":"strict-origin-when-cross-origin","content-security-policy":"default-src 'none'; style-src 'unsafe-inline'; sandbox","server":"deno/gcp-us-east4","server-timing":"fetchSource;dur=8","via":"http/2 edgeproxy-h","x-amz-cf-id":"nwhwyjwNp_Val3T1dS5gKFOyurNKnd6J_8c5qW5hw0LWEzBS5yWVsA==","x-amz-cf-pop":"IAD61-P1","cache-control":"public, max-age=31536000, immutable","x-amz-replication-status":"COMPLETED","accept-ranges":"bytes","strict-transport-security":"max-age=63072000; includeSubDomains; preload","x-amz-server-side-encryption":"AES256","x-amz-version-id":"6C1lqQfo75UJbg.xg7FCTc3xVk61mlcA","vary":"Accept-Encoding, Origin","x-cache":"Hit from cloudfront"},"url":"https://deno.land/std@0.204.0/streams/byte_slice_stream.ts","time":1741690570}